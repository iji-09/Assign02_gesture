# 🚦 손 제스처 기반 신호등 제어 시스템 (Arduino + p5.js)

## 프로젝트 개요

이 프로젝트는 **아두이노(Arduino)** 와 **p5.js (웹 기반 인터페이스)** 를 시리얼 통신으로 연동하여,  
**웹캠으로 손 제스처를 인식하거나 버튼을 누르거나 슬라이더를 조절**해서 신호등을 제어할 수 있도록 만든 인터랙티브 시스템입니다.

---

## 🛠 시스템 구성

| 구성 요소 | 설명 |
|-----------|------|
| Arduino Uno | LED와 버튼이 연결되어 있으며, 신호등 동작을 담당합니다 |
| LED 3개 | 빨강, 노랑, 초록불 제어 |
| 버튼 3개 | 각 버튼마다 다른 모드 실행 (버튼 1: 빨간불, 버튼 2: 전체 깜빡이기, 버튼 3: 신호등 다시 시작) |
| 가변저항 | LED 밝기 조절 |
| p5.js + ml5.js | 손 제스처 인식 및 슬라이더/버튼 UI, 아두이노와의 시리얼 통신 |
| Handpose 모델 | 손가락 위치를 추적하여 제스처를 인식 |

---

## ⚙ 주요 기능

### 신호등 기본 기능
- 빨간불 → 노란불 → 초록불 → 깜빡이는 초록불 → 노란불 → 다시 빨간불 순서로 반복됩니다.
- 각 불의 지속 시간은 슬라이더 또는 시리얼 명령으로 조절할 수 있습니다.

### 모드 전환
| 모드 | 실행 방법 | 설명 |
|------|-----------|------|
| 기본 신호등 모드 | 기본 상태 or 버튼3 | 일반적인 신호등 순환 동작 |
| 빨간불 전용 모드 | 버튼1 or 제스처(🤙) | 빨간불만 켜짐 |
| 전체 깜빡이기 모드 | 버튼2 or 제스처(👆) | 모든 LED가 깜빡임 |
| 신호등 OFF | 버튼3 다시 누르기 or 제스처(👌) | 모든 LED OFF, 기능 멈춤 |

---

## ✋ 제스처 인식 기능

웹캠에서 손을 인식하여 아래 제스처에 따라 기능이 실행됩니다:

| 제스처 | 의미 | 동작 |
|--------|------|------|
| ✊ 주먹 | 슬라이더 선택 | 빨간불 시간 조절 |
| ✌️ 브이 | 슬라이더 선택 | 노란불 시간 조절 |
| 🖐 손바닥 | 슬라이더 선택 | 초록불 시간 조절 |
| 🤙 엄지검지 | 버튼1 기능 | 빨간불 전용 모드 On/Off |
| 👆 검지만 펴기 | 버튼2 기능 | 전체 깜빡이기 On/Off |
| 👌 OK 포즈 | 버튼3 기능 | 신호등 On/Off 전환 |

슬라이더를 선택한 뒤 손을 좌우로 움직이면 해당 슬라이더 값이 변경되고,  
바뀐 값은 자동으로 아두이노에 전송됩니다.

---

## 시리얼 통신 명령 (p5.js ↔ Arduino)

| 명령어 | 의미 |
|--------|------|
| `1` | 신호등 시작 |
| `0` | 신호등 종료 |
| `r` | 빨간불 전용 모드 시작 |
| `b` | 전체 LED 깜빡이기 모드 시작 |
| `BRIGHTNESS_SET:숫자` | LED 밝기 설정 (0~255) |
| `TIMING:RED=2000,YELLOW=500,GREEN=2000` | 각 불의 지속 시간 설정 (단위: ms) |

Arduino는 신호등 상태를 다음처럼 p5.js로 보내고, p5.js는 UI에 반영합니다:

```
RED
YELLOW
GREEN
GREENBLINK
YELLOW2
BUTTON1_ON / OFF
BUTTON2_ON / OFF
BUTTON3_ON / OFF
BRIGHTNESS:255
```

---

## ▶️ 실행 방법

1. **Arduino IDE**에서 아두이노 코드를 업로드합니다.
2. **p5.js 웹 인터페이스**에서 시리얼 연결 버튼을 클릭하여 Arduino와 연결합니다.
3. 슬라이더 또는 제스처로 신호등을 조절하고, 버튼을 눌러 모드를 전환할 수 있습니다.

---

## 코드 작동 원리

### 전체 흐름 요약

```
p5.js (웹 UI) ↔ 아두이노 (신호등 제어)  
        ↑                         ↓  
   슬라이더 조절           밝기/버튼 상태 전송
   버튼 클릭               신호등 상태 전송
   제스처 제어
```

### 주요 변수 및 구조

- `brightness`, `redTime`, `yellowTime`, `greenTime`  
  → p5.js에서 슬라이더로 제어하며 아두이노로 전송됨

- `currentLight`, `mode`  
  → 현재 신호등 색상과 모드 상태를 저장 (red, yellow, green 등)

- `hands[]`, `activeSlider`, `lastGestureTime`  
  → ml5.js Handpose 모델로 손 제스처 인식하여 슬라이더나 버튼을 제어

---

### 시리얼 통신 방식

#### p5.js → Arduino 전송 형식
| 명령 | 설명 |
|------|------|
| `"1"` | 신호등 기능 시작 |
| `"0"` | 신호등 기능 정지 |
| `"r"` | 빨간불만 켜기 |
| `"b"` | 모든 LED 깜빡이기 |
| `"BRIGHTNESS_SET:[값]"` | LED 밝기 설정 |
| `"TIMING:RED=[값],YELLOW=[값],GREEN=[값]"` | 각 색상의 점등 시간 설정 |

#### Arduino → p5.js 전송 형식
| 데이터 | 설명 |
|--------|------|
| `"RED"` | 빨간불 상태 전송 |
| `"YELLOW"` | 노란불 상태 전송 |
| `"GREEN"` | 초록불 상태 전송 |
| `"GREENBLINK"` | 초록불 깜빡이기 상태 전송 |
| `"YELLOW2"` | 두 번째 노란불 상태 |
| `"BRIGHTNESS:[값]"` | 가변저항으로 읽은 밝기 값 |
| `"BUTTON1_ON"`, `"BUTTON1_OFF"` | 버튼 1 상태 전송 |
| `"BUTTON2_ON"`, `"BUTTON2_OFF"` | 버튼 2 상태 전송 |
| `"BUTTON3_ON"`, `"BUTTON3_OFF"` | 버튼 3 상태 전송 |

---

### 동작 방식 요약

#### 1. p5.js (웹 인터페이스)

- **setup()**  
  - 슬라이더, 버튼 생성  
  - Handpose 모델 로드  
  - 시리얼 포트 연결 준비

- **draw()**  
  - 신호등 상태 UI 출력  
  - 손 제스처 인식 및 슬라이더/버튼 제어  
  - 신호등 상태에 따라 `updateTrafficLight()` 실행

- **제스처로 슬라이더 제어**  
  - ✊: 빨간불 슬라이더  
  - ✌️: 노란불 슬라이더  
  - 🖐: 초록불 슬라이더  
  - 손 좌우 이동으로 값 조절

- **제스처로 버튼 기능 실행**  
  - 🤙: 빨간불 전용 모드  
  - 👆: 모든 LED 깜빡이기  
  - 👌: 신호등 켜기/끄기

#### 2. 아두이노 (Task 기반 제어)

- `TaskScheduler` 라이브러리로 빨강 → 노랑 → 초록 → 깜빡임 → 노랑 순서 자동 실행

- 각 Task는 다음처럼 동작:
  - `red()` → 2초 후 `yellow1()` 실행  
  - `yellow1()` → 0.5초 후 `green()` 실행  
  - `green()` → 2초 후 `greenBlink()` 실행  
  - `greenBlink()` → 6번 깜빡임 후 `yellow2()` 실행  
  - `yellow2()` → 다시 `red()`로 순환

- 밝기 조절은 **가변저항(POT)** 또는 p5.js 슬라이더를 통해  
  → `analogWrite(pin, 밝기)` 로 적용됨

- 버튼 인터럽트를 사용하여 **즉시 모드 전환** 가능  
  → 버튼 누르면 Task 중단 후 해당 기능 실행

---

## 주요 함수 설명

---

### p5.js 주요 함수

| 함수 이름 | 설명 |
|-----------|------|
| `setup()` | p5.js의 기본 초기화 함수. 캔버스 생성, 버튼 및 슬라이더 설정, Handpose 모델 로드, 시리얼 포트 준비 등을 수행 |
| `draw()` | 매 프레임마다 호출되는 함수. 신호등 UI 그리기, 제스처 인식, 신호등 상태 업데이트 등의 역할 수행 |
| `connectBtnClick()` | 사용자가 "아두이노 연결" 버튼을 클릭하면 실행됨. 사용 가능한 시리얼 포트에 연결하거나 연결 해제 |
| `readSerialData()` | 시리얼 포트로부터 들어오는 데이터를 계속해서 읽으며, 한 줄씩 처리하여 `updateTrafficState()`에 전달 |
| `updateTrafficState(data)` | 아두이노에서 보낸 데이터를 기반으로 p5.js 내부 상태 업데이트 (LED 상태, 버튼 상태 등) |
| `sendSerialData(data)` | p5.js → Arduino로 문자열 형태의 데이터를 전송하는 함수 |
| `sendBrightnessData()` | 슬라이더로 조절한 밝기 값을 아두이노로 전송 |
| `sendTimingData()` | 슬라이더로 조절한 신호등 점등 시간(R/Y/G)을 아두이노로 전송 |
| `toggleRedOnly()` | 빨간불 only 기능을 토글 (on/off) |
| `toggleBlinking()` | 모든 LED 깜빡이기 기능을 토글 (on/off) |
| `toggleTraffic()` | 기본 신호등 기능을 켜거나 끄는 기능 |
| `updateTrafficLight()` | 현재 `currentLight` 값에 따라 신호등 상태를 시간 기반으로 순환 |
| `detectGestureAndControlSlider()` | 손 제스처 인식 결과에 따라 슬라이더 선택 및 버튼 기능 실행 |
| `drawHandKeypoints()` | Handpose 모델이 감지한 손가락 위치에 점(원)을 표시 |
| `drawTrafficLights()` | 현재 신호등 상태에 맞춰 UI 상의 LED 점등 상태를 시각적으로 표현 |
| `blinkAllLEDs()` | 모든 LED를 일정 주기로 깜빡이도록 UI에 표시 (모드: all-blink) |

---

### Arduino 주요 함수

| 함수 이름 | 설명 |
|-----------|------|
| `setup()` | 아두이노 시작 시 한 번 실행. 핀모드 설정, 인터럽트 등록, 시리얼 시작, 신호등 첫 Task 시작 |
| `loop()` | 아두이노 메인 루프. TaskScheduler 실행, 밝기 측정 및 전송, 시리얼 명령 처리 |
| `adjustBrightness()` | 가변저항으로부터 밝기 값을 읽고, 현재 점등 중인 LED에 PWM 적용 |
| `processSerialInput()` | 시리얼 입력을 처리하여 밝기 조절, 주기 설정, LED 제어 명령을 수행 |
| `stopAllTask()` | 현재 실행 중인 모든 Task를 중단하고 모든 LED를 끔 |
| `stopState()` | 모든 상태 변수(B1, B2, B3, Traffic)를 false로 초기화 |
| `Restart_Traffic()` | 신호등 기능 재시작. 빨간불 Task부터 다시 시작함 |
| `button1Interrupt()` | 버튼1 (Red only) 눌렀을 때의 인터럽트 처리 함수 |
| `button2Interrupt()` | 버튼2 (모든 LED 깜빡이기) 눌렀을 때의 인터럽트 처리 함수 |
| `button3Interrupt()` | 버튼3 (신호등 On/Off) 눌렀을 때의 인터럽트 처리 함수 |
| `redOE() ~ yellow2OD()` | Task의 시작 조건, 콜백 함수, 종료 시 실행되는 함수들로 구성. 신호등 점등 순서를 TaskScheduler를 통해 처리 |
| `allLEDBlinkCB()` | 깜빡이기 모드에서 호출되는 Task 콜백. LED 상태를 반전시켜 깜빡이게 함 |
| `allLEDBlinkOD()` | 깜빡이기 모드가 끝났을 때 모든 LED를 끔 |

---

